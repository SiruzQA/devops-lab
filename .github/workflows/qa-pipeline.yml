name: K3s Platform QA Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger imkanı

jobs:
  qa-tests:
    name: Platform QA Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml
    
    - name: Install K3s
      run: |
        curl -sfL https://get.k3s.io | sh -
        sudo chmod 644 /etc/rancher/k3s/k3s.yaml
        mkdir -p ~/.kube
        sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
        sudo chown $USER ~/.kube/config
        
        # K3s tam hazır olana qədər gözlə
        timeout 120 bash -c 'until kubectl get nodes | grep -q "Ready"; do sleep 2; done'
        
        echo "K3s installed successfully"
        kubectl get nodes
    
    - name: Build Docker Image
      run: |
        cd docker
        docker build -t myapp:latest .
        echo "Docker image built successfully"
    
    - name: Import Image to K3s
      run: |
        # K3s containerd-ə image import et
        docker save myapp:latest -o /tmp/myapp.tar
        sudo k3s ctr images import /tmp/myapp.tar
        
        # Image düzgün import olduğunu yoxla
        echo "Verifying image in K3s containerd:"
        sudo k3s ctr images ls | grep myapp
        
        # Image tapılmadısa, exit 1 ilə dayandır
        if ! sudo k3s ctr images ls | grep -q myapp; then
          echo "ERROR: Image not found in K3s containerd!"
          exit 1
        fi
        
        echo "✅ Image successfully imported to K3s"
    
    - name: Deploy to K3s
      run: |
        cd k3s
        
        # Deployment
        kubectl apply -f deployment.yaml
        
        # Service
        kubectl apply -f service.yaml
        
        # Ingress
        kubectl apply -f ingress.yaml
        
        echo "Resources deployed to K3s"
        
        # Pod-ların yaranmasını gözlə (max 30 saniyə, hər saniyə yoxla)
        echo "Waiting for pods to be created..."
        for i in {1..30}; do
          POD_COUNT=$(kubectl get pods -l app=myapp --no-headers 2>/dev/null | wc -l)
          if [ "$POD_COUNT" -gt 0 ]; then
            echo "✅ Pods created (found $POD_COUNT pods)"
            break
          fi
          echo "Waiting for pods... ($i/30)"
          sleep 1
        done
        
        # Pod yaranmadısa, debug info göstər və dayandır
        if [ "$POD_COUNT" -eq 0 ]; then
          echo "❌ ERROR: No pods were created!"
          echo "=== Deployment Status ==="
          kubectl get deployment myapp-deployment -o wide
          echo "=== Events ==="
          kubectl get events --sort-by='.lastTimestamp' | tail -20
          exit 1
        fi
        
        # İndi deployment-in ready olmasını gözlə
        kubectl rollout status deployment/myapp-deployment --timeout=120s
        
        # Status
        echo "=== Final Status ==="
        kubectl get pods,svc,ingress
    
    - name: Run Health Check Tests
      id: health_tests
      run: |
        python tests/k3s_qa_tests.py
      continue-on-error: true

    - name: Run Ingress Routing Tests
      id: routing_tests
      run: |
        # Ingress controller hazır olmasını gözlə
        sleep 10
        
        # Traefik ingress controller yoxla
        kubectl get pods -n kube-system | grep traefik || echo "Traefik not found"
        
        # Test routing
        echo "Testing ingress routing..."
        python tests/k3s_qa_tests.py
      continue-on-error: true

    - name: Collect Logs on Failure
      if: failure()
      run: |
        echo "=== Pod Status ==="
        kubectl get pods -o wide
        
        echo "=== Pod Descriptions ==="
        kubectl describe pods
        
        echo "=== Pod Logs ==="
        # Hər pod-un loglarını yoxla
        for pod in $(kubectl get pods -o name); do
          echo "Logs for $pod:"
          kubectl logs $pod || echo "No logs available"
        done
        
        echo "=== Service Status ==="
        kubectl get svc -o wide
        
        echo "=== Ingress Status ==="
        kubectl get ingress -o wide
        
        echo "=== Events ==="
        kubectl get events --sort-by='.lastTimestamp'
    
    - name: Generate Test Report
      if: always()
      run: |
        echo "## QA Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Health check test nəticəsi
        if [ "${{ steps.health_tests.outcome }}" == "success" ]; then
          echo "✅ Health Check Tests: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Health Check Tests: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Routing test nəticəsi
        if [ "${{ steps.routing_tests.outcome }}" == "success" ]; then
          echo "✅ Routing Tests: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Routing Tests: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Pod Status" >> $GITHUB_STEP_SUMMARY
        kubectl get pods -o wide >> $GITHUB_STEP_SUMMARY || true
    
    - name: Cleanup
      if: always()
      run: |
        # Test sonunda yaradılan resources sil
        kubectl delete -f k3s/deployment.yaml --ignore-not-found=true
        kubectl delete -f k3s/service.yaml --ignore-not-found=true
        kubectl delete -f k3s/ingress.yaml --ignore-not-found=true

  scaling-tests:
    name: Scaling and Load Tests
    runs-on: ubuntu-latest
    needs: qa-tests  # qa-tests tamamlanana qədər gözlə

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install K3s
      run: |
        curl -sfL https://get.k3s.io | sh -
        sudo chmod 644 /etc/rancher/k3s/k3s.yaml
        mkdir -p ~/.kube
        sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
        sudo chown $USER ~/.kube/config
        # K3s tam hazır olana qədər gözlə
        timeout 120 bash -c 'until kubectl get nodes | grep -q "Ready"; do sleep 2; done'
    
    - name: Clean Up Previous Resources
      run: |
        # Əvvəlki testdə qalan resources sil
        echo "Cleaning up any existing resources..."
        kubectl delete deployment --all --ignore-not-found=true
        kubectl delete service --all --ignore-not-found=true
        kubectl delete ingress --all --ignore-not-found=true
        
        # Bütün pod-ların silinməsini gözlə
        echo "Waiting for all pods to be deleted..."
        kubectl wait --for=delete pod --all --timeout=60s || true
        
        echo "Cleanup completed"
        kubectl get pods --all-namespaces
    
    - name: Build and Deploy
      run: |
        cd docker
        docker build -t myapp:latest .
        docker save myapp:latest -o /tmp/myapp.tar
        sudo k3s ctr images import /tmp/myapp.tar
        
        # Image yoxla
        sudo k3s ctr images ls | grep myapp
        
        cd ../k3s
        kubectl apply -f deployment.yaml
        kubectl apply -f service.yaml
        
        # Pod-ların yaranmasını yoxla (max 30 saniyə)
        echo "Waiting for pods to be created..."
        for i in {1..30}; do
          POD_COUNT=$(kubectl get pods -l app=myapp --no-headers 2>/dev/null | wc -l)
          if [ "$POD_COUNT" -gt 0 ]; then
            echo "✅ Pods created"
            break
          fi
          sleep 1
        done
        
        # Deployment ready olmasını gözlə
        kubectl rollout status deployment/myapp-deployment --timeout=120s
    
    - name: Test Horizontal Scaling
      run: |
        echo "=== Initial Pod Count ==="
        kubectl get pods -l app=myapp
        
        DEPLOYMENT_NAME="myapp-deployment"
        
        # İlk replica count-u yoxla
        INITIAL_REPLICAS=$(kubectl get deployment $DEPLOYMENT_NAME -o jsonpath='{.spec.replicas}')
        echo "Initial replicas: $INITIAL_REPLICAS"
        
        # 5 replica-ya scale et
        echo "=== Scaling to 5 replicas ==="
        kubectl scale deployment/$DEPLOYMENT_NAME --replicas=5
        
        # Scaling tamamlanana qədər gözlə
        kubectl rollout status deployment/$DEPLOYMENT_NAME --timeout=180s || {
          echo "⚠️  Scaling failed, checking status..."
          kubectl get pods -l app=myapp
          kubectl describe pods -l app=myapp | tail -20
        }
        
        sleep 5
        
        # Yalnız myapp-deployment-in pod-larını say (replicaset hash ilə)
        POD_COUNT=$(kubectl get pods -l app=myapp -o jsonpath='{range .items[*]}{.metadata.ownerReferences[0].name}{"\n"}{end}' | grep "^myapp-deployment-" | wc -l)
        
        echo "Pod count after scaling: $POD_COUNT"
        echo "Expected: 5"
        
        # Pod sayını yoxla
        if [ "$POD_COUNT" -eq 5 ]; then
          echo "✅ Scaling test PASSED (exactly ${POD_COUNT} pods running)"
        elif [ "$POD_COUNT" -ge 3 ]; then
          echo "⚠️  Scaling test PARTIAL (${POD_COUNT} pods running, expected 5)"
        else
          echo "❌ Scaling test FAILED (only ${POD_COUNT} pods running)"
          kubectl get pods -l app=myapp -o wide
          kubectl get replicasets
          exit 1
        fi
        
        # Geri 3 replica-ya qaytar
        echo "=== Scaling back to 3 replicas ==="
        kubectl scale deployment/$DEPLOYMENT_NAME --replicas=3
        kubectl rollout status deployment/$DEPLOYMENT_NAME --timeout=120s
        kubectl get pods -l app=myapp
    
    - name: Test Rolling Update
      run: |
        echo "=== Testing Rolling Update ==="
        
        DEPLOYMENT_NAME="myapp-deployment"
        
        # Annotation əlavə edə bilə rolling update trigger et
        TIMESTAMP=$(date +%s)
        kubectl annotate deployment/$DEPLOYMENT_NAME test-rollout=$TIMESTAMP --overwrite
        
        # Rolling update tamamlanana qədər gözlə
        kubectl rollout status deployment/$DEPLOYMENT_NAME --timeout=120s || {
          echo "⚠️  Rollout did not complete in time"
        }
        
        # Rolling update tarixini göstər
        echo "=== Rollout History ==="
        kubectl rollout history deployment/$DEPLOYMENT_NAME || true
        
        echo "=== Current Pods ==="
        kubectl get pods -l app=myapp
        
        echo "✅ Rolling update test completed"
    
    - name: Cleanup
      if: always()
      run: |
        # Test sonunda yaradılan bütün resources sil
        echo "Final cleanup..."
        kubectl delete deployment --all --ignore-not-found=true
        kubectl delete service --all --ignore-not-found=true
        kubectl get pods